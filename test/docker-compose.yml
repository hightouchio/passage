version: "3.9"
services:
  # passage is the tunnel service
  passage:
    build: ../
    command: server --api --normal --reverse
    environment:
      LOG_LEVEL: debug
      PGHOST: postgres
      PGPORT: 5432
      PGUSER: passage
      PGDBNAME: passage
      PGSSLMODE: disable
      HOST_KEY: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBbHc5N0ZFMzlKZzhBdG1RMFZzaTZISDAyNHo4UWlzTXBvSHpLNTNCZE53dlRIdnhpTmlNS29KZ3kvUFZuCldoaDVTbnMxMS8yMmoxYlN4czBXUDdld2RkNGNOZHdacFNQakNGN21wakM3UlQxdnI2a2ZHajdBRCtRN2xXTGVhZzdicWxMbnJ2Q1MKUXpvdXBmRVlHYWNkY1pzeGxkSHowYlZHTGhXenpWZG10cXpJNVlzV21vRkZ6Nko4QkVySWprZ1lCZTBiN3RoK3lYUlVVWk14OEQzSQpNcm1GQ3M0K0pZVHIxYm90U1B6TldoejdwNWsxMlFrZ1pXc0hhWFhMTllWT3VLaTRVdTNZTkZnZG5VeVRmdlJpZlhpbm5JVFZXYTJMCmlBbEpRNUZVUHRFUDlISDhQaWNGSkF6d0s3UTRYZWhOWjdLcXJqdXRWV2tEc1RzSjJjS3BGd0lEQVFBQkFvSUJBQnFGOGxOZldpcDcKaWVGOGVLQWdRR1ZPS3Z2OWo3YjlpMnFOWHNjQ09LdTRuTW9kQUZXSEU0K2RDWjdXcTkzcTNDa1N0eUtFZnJCdVN6WHl2b3hUZ1YxQQpzVzFYaHYweTd1TUNYcmNoYVZBLytFTThpNlI5RGhYOE9lWUI1UkYwS0dlZ2hPTjNoQWJmeVY4RGxQcTBGL3hoaG5SSzErZWpUMzQ1CiswYjdxS0k4TDdMUTA0VHdPYXJjT3lnZzEzZjdCa1FCNzc0S2F6MDJHZGVaU08wWDBqdkQ2cWdkam5uZDI4ZFpvRjBvRWt6QUYzcnMKcFZUMlVTWEtjSHVsb3FjQlN2Q1pWTm5VMW9mZFdiSGE1M2FMZmRqcHVNMW80ZEtvOTNBUG4xWnlkRHpoaEVqMXk4ak9uSEUzcGtiUApoTnZUSUl6V3I5QXdQR1BnNk5tT1FuU09Jb0VDZ1lFQTh2SjhpcXhkNG4xRVlLTjQ3TGpvNzZ4VTFaTVBwZ1JnMmhIbFFVb2lFbTExCmtUVzJFNHByNng2ODFwbEtLYTBxdGdEcmtscmd1YjY0U1NnUEtDeUQzV2lUS2N5cFRyeTA4ZEMzZEZzV1hiQW0wUmU1dHZyeGNLVEkKTyt2ZFJHNGtjSGI2Z1p1WVlvclVHMFdDbzROK2NqSE9Md2piUWJFb2gzdXgyQzJPelVFQ2dZRUFueTB0YXg3alI2cWFUczVYNkdnOAoweE5FT3VFaHB1Q1dwWWJIY2kvSHczdnZWaVNET3NyZ29zM2ZndVdHMHYvbDRBd1VLNzZCUVI0V0tSQWUxb3UxdkhkNmFvWlJzd2d1ClVOQnJBQmhZR25aQTB6a2pKV2tQN2tmOUdaTzdOYzVkdFVKM0NpNys2WEFWcTN5WEZNU0Z2d0J0U2lCUWRNNFIrTm05c280NDZGY0MKZ1lCdWdhSG9xZktpZlB4SFFOUldTTjJiZHpXM1dBYzhLcTJyUTR5V0lCUlRjWHFTckcyL2dhMEk2NWhWdkxBaE9PVSttRGlPLzh0TQpjZFg5WUwxVU5ydGNVSjd2Mm1vQXFKRmRsT1I5aHBrcjBGNDNxYVVOK0NNdWE2V3dxOTZmcThIamJoc1FMU2dwV3FDVUx3LzNORzZsCm5zWDhXdmp3YnBiUzJZN1JtQmRtZ1FLQmdERGMxM0pvdXZCSENMTmtXRXY1bzZKUDZjUUJWQ2s4REVLbnl4WGNZUUE3VFU4dVNqS0UKRU0wcFVaR0hFQW81ajhGbE05UHgyUSs2UXFjOFVac2VyQjA4dUJGM1JpRWxROEovR0RtaFAzcHdEcHBJa2Vkc0J2M29qMk9JbkJGNgpWZjNNZDJwaTN0R2VIS2pWeURNUjJOUzNOdFZvY2dwSkwrOHFPRGRWdlZabEFvR0JBTmJ6emppRWg0NFVKM0VHYjllVkY4TExkWGIzClkrcXp3cHZmT2wvVk9OaE00Vzl4aUFvR0UwRDkrbVNjcXBQSS9hTFRUYTBNbGFrWVhGRW95QVVLRnpyUUtQM1JWcHQyMUQ1NTRCamQKcVJXSUdDTWljQ2RRb1FpQ216Ny9RaGszejhaWE16Nmk4WTY0QlMxVUxQSm5kTVJMdFNYQlJyUldYaWxBd1RDbDlyWUYKLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0K
      HTTP_ADDR: 0.0.0.0:6000
    ports:
      - "36000:6000"
    depends_on:
      - "postgres"
    networks:
      - public
      - passage

  # postgres is the hidden Postgres DB backing the passage service.
  postgres:
    image: postgres:11.6
    restart: always
    environment:
      POSTGRES_USER: "passage"
      POSTGRES_DB: "passage"
      POSTGRES_HOST_AUTH_METHOD: trust
    healthcheck:
      test: "pg_isready -U passage -d passage"
    ports:
      - "35432:5432"
    volumes:
      - ../sql/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    networks:
      - passage

  # remote_ssh represents a public-facing Bastion server running in a remote network.
  remote_bastion:
    image: lscr.io/linuxserver/openssh-server
    environment:
      USER_NAME: hightouch
    networks:
      - public
      - hidden
    ports:
      - "2222:2222"
    volumes:
      - type: volume
        source: ssh-public-keys
        target: /public-keys
        read_only: true

  # remote_service represents a hidden service running in a remote network.
  remote_service:
    image: hashicorp/http-echo
    command: -text "You're talking to the remote service!"
    networks:
      - hidden

networks:
  # Public network mimics the open internet.
  public:
    name: public

  # Passage network represents the hidden Passage service.
  passage:
    name: passage

  # Hidden mimics the hidden remote network.
  hidden:
    name: hidden

volumes:
  # Create a volume for the test runner to authorize public keys.
  ssh-public-keys: