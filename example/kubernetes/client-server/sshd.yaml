apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: test
  name: openssh-server
  labels:
    app: openssh-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: openssh-server
  template:
    metadata:
      name: openssh-server
      labels:
        app: openssh-server
    spec:
      containers:
        - name: openssh-server
          image: lscr.io/linuxserver/openssh-server:latest
          imagePullPolicy: IfNotPresent

          env:
            - name: PASSWORD_ACCESS
              value: "false"
            - name: SUDO_ACCESS
              value: "false"
            - name: USER_NAME
              value: "passage"

            - name: "PUBLIC_KEY_FILE"
              value: "/config/keys/authorized_keys"

            - name: "LOG_STDOUT"
              value: "true"

          volumeMounts:
            - name: sshd
              subPath: authorized_keys
              mountPath: /config/keys/authorized_keys
              readOnly: false

            - name: sshd
              subPath: init.d
              mountPath: /custom-cont-init.d/agent-forwarding

      restartPolicy: Always

      volumes:
        - name: sshd
          configMap:
            name: openssh-server
---

apiVersion: v1
kind: Service
metadata:
  namespace: test
  name: openssh-server
spec:
  selector:
    app: openssh-server
  type: ClusterIP
  ports:
    - name: "http"
      protocol: TCP
      port: 22
      targetPort: 2222

---

apiVersion: v1
kind: ConfigMap
metadata:
  namespace: test
  name: openssh-server
data:
  init.d: |
    #!/bin/bash
    set -e
    sed -i 's/#AllowAgentForwarding yes/AllowAgentForwarding yes/g' /etc/ssh/sshd_config
    sed -i 's/AllowTcpForwarding no/AllowTcpForwarding yes/g' /etc/ssh/sshd_config
    sed -i 's/GatewayPorts no/GatewayPorts yes/g' /etc/ssh/sshd_config
    sed -i 's/X11Forwarding no/X11Forwarding yes/g' /etc/ssh/sshd_config

  authorized_keys: |
    ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDuh1dLOj0h1YkukVqidncVP7IVIInwc7Dm8K+5b7OYdNhwsOwquBgkLq9ej6qOqD/xxjtrVH+eWoO19xMXOVJhFA+7fgkgvmppkKL8As4NBQzQP6nDkDUlB58cz1BNB6stf0IeODfbQKDZt7SVioi3QGt4q/vmcqhEw5pdZ2cEUtPR9Stv/3b7MadEwwqXwGljC99gcE5Hsd6UJlW8sJwyn1Bk2hZvnyoXJzBywwCBdUwRQ0UNkawXUEE9KrN2N8QuTWANweZoJEzUgKLkdZU/QGCasvcSM3X46ZvE/9eCXjBiKVW9ZQI3OfPdihwpB4CM1YBOw/r9ilPlzeU8clt0tvU/ujjXSSYl3Yib0nUo+pIqQIkvp7bZ3OxAnGFxhJyccfGugJCzNEFNBZhLbk/rOsZYwN6WuMbcVZ6Jvzf7Dp7DtyAgLcxY8G1AWT7IfWxrcweAgRZJ5Xwt3LnrSK+H4+GbMOPEgr6fIVoBXkiHNWLhhIldyBx0ZS5dcmibP+vxpAIyw3G1iJmG/8neWwNW9gbBqxxs2ppAGEwlhFskWA3K/jT98LgJ3arVHu8Tz8txm06Bd5hiDjCvkDo4cu3ZdXIKBkQQDG5hNvHN1L1wnjuIyDY3l990Y0fpjFq4aapaOFXgGkAcBMZqEG3wQEQfW1vR9ES3dQISrBJ+62rnjw==
